# دليل إدارة رسوم التوصيل

## نظرة عامة
هذا الدليل يشرح كيفية إدارة رسوم التوصيل من خلال لوحة التحكم (Admin Dashboard) والتأكد من تطابق جميع التطبيقات (تطبيق العميل، تطبيق السائق، والسيرفر) مع إعدادات قاعدة البيانات.

---

## 1. الإعدادات العامة (General Settings)

### الوصول إلى الإعدادات
1. ادخل لوحة التحكم (Admin Dashboard)
2. انتقل إلى **إدارة رسوم التوصيل** (Delivery Fees Management)
3. اختر تبويب **الإعدادات العامة** (General Settings)

### خطوات الإعداد

#### اختيار طريقة الحساب
اختر من الخيارات التالية:
- **رسوم ثابتة (Fixed)**: رسوم موحدة لجميع الطلبات
- **حسب المسافة (Per KM)**: رسوم أساسية + رسوم إضافية لكل كيلومتر
- **حسب المناطق (Zone-Based)**: رسوم مختلفة حسب مناطق التوصيل
- **حسب إعدادات المطعم (Restaurant Custom)**: كل مطعم له إعداداته الخاصة

#### تعيين الرسوم الأساسية
- **الرسوم الأساسية (Base Fee)**: المبلغ الأساسي بالريال (مثال: 5)
- **رسوم لكل كيلومتر (Per KM Fee)**: المبلغ الإضافي لكل كيلومتر (مثال: 2)
- **الحد الأدنى (Min Fee)**: أقل رسوم يمكن فرضها (مثال: 3)
- **الحد الأقصى (Max Fee)**: أعلى رسوم يمكن فرضها (مثال: 50)

#### حد التوصيل المجاني
- **حد التوصيل المجاني (Free Delivery Threshold)**: إذا تجاوز إجمالي الطلب هذا المبلغ، يكون التوصيل مجاني
- اتركه على 0 لتعطيل هذه الميزة

#### موقع المتجر الرئيسي
يتم استخدام موقع المتجر كنقطة انطلاق لحساب مسافة التوصيل:
1. اضغط على زر **تحديد الموقع على الخريطة** (Select Location on Map)
2. اختر موقع المتجر على الخريطة
3. سيتم تحديث إحداثيات خط العرض (Latitude) وخط الطول (Longitude) تلقائياً

#### حفظ الإعدادات
1. تحقق من جميع البيانات المدخلة
2. اضغط زر **حفظ الإعدادات** (Save Settings)
3. سيظهر إشعار بنجاح الحفظ
4. الإعدادات ستُحفظ في قاعدة البيانات وستُستخدم عند حساب رسوم التوصيل

---

## 2. مناطق المسافات (Delivery Zones)

استخدم هذا القسم لتعريف نطاقات مسافة مع رسوم محددة.

### إضافة منطقة جديدة
1. اختر تبويب **مناطق المسافات** (Distance Zones)
2. اضغط زر **إضافة نطاق جديد** (Add New Zone)
3. أدخل البيانات التالية:
   - **اسم المنطقة (Name)**: مثال "الحي الشرقي"
   - **الوصف (Description)**: وصف اختياري
   - **من مسافة (Min Distance)**: بالكيلومتر
   - **إلى مسافة (Max Distance)**: بالكيلومتر
   - **رسوم التوصيل (Delivery Fee)**: بالريال
   - **الوقت المتوقع (Estimated Time)**: مثال "20-30 دقيقة"
4. اضغط **حفظ** (Save)

**مثال:**
- المنطقة 1: من 0 إلى 5 كم = 10 ريال
- المنطقة 2: من 5 إلى 10 كم = 20 ريال
- المنطقة 3: من 10 إلى 20 كم = 35 ريال

---

## 3. المناطق الجغرافية (Geo-Zones)

استخدم هذا القسم لتعريف مناطق جغرافية دقيقة باستخدام الإحداثيات (Polygons).

### إضافة منطقة جغرافية
1. اختر تبويب **المناطق الجغرافية** (Geo-Zones)
2. اضغط زر **إضافة منطقة جغرافية** (Add Geo-Zone)
3. أدخل:
   - **اسم المنطقة**: مثال "وسط المدينة"
   - **الوصف**: وصف اختياري
   - **الإحداثيات (JSON)**: قائمة بنقاط الإحداثيات التي تشكل حدود المنطقة
   
**تنسيق الإحداثيات:**
```json
[
  {"lat": 24.7136, "lng": 46.6753},
  {"lat": 24.7150, "lng": 46.6780},
  {"lat": 24.7120, "lng": 46.6800},
  {"lat": 24.7100, "lng": 46.6750}
]
```

### حذف منطقة جغرافية
1. ابحث عن المنطقة في القائمة
2. اضغط على زر الحذف (Trash icon)
3. ستُحذف المنطقة من الفور

---

## 4. القواعس الديناميكية (Delivery Rules)

استخدم هذا القسم لتعريف قواعس مخصصة لحساب الرسوم بناءً على شروط معينة.

### أنواع القواعس

#### أ. قاعدة حسب المسافة (Distance Rule)
تطبق رسوم محددة للطلبات ضمن نطاق مسافة معين.

**المثال:**
- المسافة من 0-5 كم = 15 ريال

#### ب. قاعدة حسب قيمة الطلب (Order Value Rule)
تطبق رسوم محددة للطلبات ضمن نطاق قيمة معين.

**المثال:**
- من 100-200 ريال = 10 ريال توصيل
- من 200-500 ريال = توصيل مجاني

#### ج. قاعدة حسب المنطقة الجغرافية (Zone Rule)
تطبق رسوم محددة للطلبات في منطقة جغرافية معينة.

### إضافة قاعدة جديدة
1. اختر تبويب **القواعس الديناميكية** (Dynamic Rules)
2. اضغط **إضافة قاعدة** (Add Rule)
3. أدخل البيانات:
   - **اسم القاعدة**: وصف واضح
   - **نوع القاعدة**: اختر من (Distance, Order Value, Zone)
   - **الرسوم**: المبلغ المراد فرضه
   - **الأولوية**: رقم أقل = أولوية أعلى (القيمة الافتراضية: 0)
   
4. حسب نوع القاعدة، أدخل:
   - للمسافة: Min Distance, Max Distance
   - لقيمة الطلب: Min Order Value, Max Order Value
   - للمنطقة: اختر المنطقة الجغرافية من القائمة

5. اضغط **حفظ**

**ملاحظة مهمة:**
- يتم تطبيق القواعس حسب الأولوية (Priority)
- أول قاعدة مطابقة يتم تطبيقها فقط
- يجب ترتيب القواعس بعناية لضمان النتائج المطلوبة

---

## 5. الخصومات (Delivery Discounts)

استخدم هذا القسم لتقديم خصومات على رسوم التوصيل.

### أنواع الخصومات
- **نسبة مئوية (Percentage)**: مثال 20% خصم
- **مبلغ ثابت (Fixed Amount)**: مثال 5 ريال خصم

### إضافة خصم جديد
1. اختر تبويب **الخصومات** (Discounts)
2. اضغط **إضافة خصم** (Add Discount)
3. أدخل:
   - **اسم الخصم**: "توصيل مجاني للطلبات فوق 200"
   - **نوع الخصم**: النسبة المئوية أو المبلغ الثابت
   - **قيمة الخصم**: 100 (للتوصيل المجاني) أو 5 (للخصم 5 ريال)
   - **الحد الأدنى للطلب**: المبلغ الأقل لتطبيق الخصم
   - **تاريخ البداية**: متى يبدأ الخصم
   - **تاريخ النهاية**: متى ينتهي الخصم

4. اضغط **حفظ**

---

## 6. كيفية عمل النظام

### تسلسل حساب رسوم التوصيل

عند تقديم الطلب، يتم حساب رسوم التوصيل بالترتيب التالي:

1. **جلب الإعدادات**: يتم جلب إعدادات رسوم التوصيل من قاعدة البيانات
2. **تحديد الموقع**: يتم حساب المسافة من موقع المتجر إلى موقع العميل
3. **تحديد المنطقة الجغرافية**: يتم التحقق من وجود المنطقة الجغرافية للعميل
4. **تطبيق القواعس**: يتم البحث عن القواعس المطابقة وتطبيق الأولى
5. **تطبيق الخصومات**: يتم التحقق من الخصومات المتاحة
6. **تطبيق حد التوصيل المجاني**: إذا تجاوز المجموع الحد المحدد
7. **تطبيق الحد الأدنى والأقصى**: التأكد من أن الرسوم ضمن النطاق المحدد

### مثال على الحساب:
```
الطلب الأصلي: 150 ريال
المسافة: 8 كم
الإعدادات:
  - الرسوم الأساسية: 5 ريال
  - رسوم لكل كم: 2 ريال
  - الحد الأدنى: 3 ريال
  - الحد الأقصى: 50 ريال

الحساب:
1. الرسوم الأساسية = 5
2. رسوم المسافة = 8 × 2 = 16
3. الإجمالي = 5 + 16 = 21 ريال
4. تطبيق الحد الأدنى والأقصى = 21 ريال (ضمن النطاق)
5. التحقق من الخصومات = لا توجد خصومات مطابقة
6. النتيجة النهائية = 21 ريال
```

---

## 7. التطابق بين الأنظمة

### تطبيق العميل (Client App)
- عند اختيار العميل لموقع التوصيل في السلة، يتم استدعاء API `/api/delivery-fees/calculate`
- يتم عرض رسوم التوصيل على الفور
- الرسوم تُحدّث تلقائياً عند تغيير الموقع أو قيمة الطلب

### تطبيق السائق (Driver App)
- لا يحتاج السائق إلى حساب الرسوم (مسؤولية الخادم)
- يرى السائق قيمة الرسوم في بيانات الطلب
- الرسوم مسؤولة عن جزء من دخل السائق (حسب إعدادات العمولة)

### قاعدة البيانات (Database)
- جميع الإعدادات محفوظة في جداول محددة:
  - `delivery_fee_settings`: الإعدادات العامة
  - `delivery_zones`: مناطق المسافات
  - `geo_zones`: المناطق الجغرافية
  - `delivery_rules`: القواعس الديناميكية
  - `delivery_discounts`: الخصومات

### السيرفر (Server)
- يقرأ الخادم من قاعدة البيانات عند كل طلب
- يحسب الرسوم حسب البيانات المحفوظة
- يعيد النتيجة لتطبيق العميل

---

## 8. نصائح مهمة

### عند إضافة أو تعديل الإعدادات:
1. **تحقق من البيانات**: تأكد من صحة جميع القيم الرقمية
2. **اختبر الحساب**: جرّب عدة سيناريوهات مختلفة
3. **اراقب الأخطاء**: لاحظ أي رسائل خطأ وحاول حلها
4. **احفظ التغييرات**: اضغط دائماً على زر الحفظ

### أخطاء شائعة:
- **الحد الأقصى أقل من الحد الأدنى**: تأكد من أن maxFee > minFee
- **قيم غير صحيحة**: الحقول الرقمية يجب أن تحتوي على أرقام فقط
- **إحداثيات خاطئة**: تحقق من تنسيق JSON للإحداثيات
- **قواعس متعارضة**: رتب القواعس بعناية حسب الأولوية

### الصيانة الدورية:
- تحقق من الخصومات المنتهية وامسحها
- حدّث المناطق الجغرافية حسب احتياجات المدينة
- راجع القواعس الديناميكية لضمان فعاليتها

---

## 9. استكشاف الأخطاء

### مشكلة: الرسوم تظهر 0.00 في السلة
**الحل:**
1. تحقق من الإعدادات العامة - تأكد من وجود قيم محفوظة
2. تحقق من موقع المتجر - قد تحتاج لتحديثه
3. افتح جهاز التطوير (DevTools) واعرض رسائل الخطأ (Console)
4. جرّب حفظ الإعدادات مرة أخرى

### مشكلة: رسالة خطأ عند الحفظ
**الحل:**
1. تأكد من أن جميع الحقول المطلوبة مملوءة
2. تأكد من أن القيم الرقمية صحيحة (لا توجد أحرف)
3. تأكد من أن الحد الأقصى أكبر من الحد الأدنى
4. افحص رسالة الخطأ في وحدة التحكم (DevTools)

### مشكلة: التطبيقات لا تعرض الرسوم المحدثة
**الحل:**
1. امسح ذاكرة التخزين المؤقت (Cache) في التطبيق
2. أعد تشغيل التطبيق
3. تأكد من أن الخادم يستخدم آخر البيانات من قاعدة البيانات
4. قد تحتاج لإعادة تشغيل الخادم

---

## 10. جداول قاعدة البيانات

### Delivery Fee Settings
```sql
CREATE TABLE delivery_fee_settings (
  id UUID PRIMARY KEY,
  restaurant_id UUID (NULL for global settings),
  type VARCHAR (fixed, per_km, zone_based, restaurant_custom),
  base_fee DECIMAL,
  per_km_fee DECIMAL,
  min_fee DECIMAL,
  max_fee DECIMAL,
  free_delivery_threshold DECIMAL,
  store_lat DECIMAL,
  store_lng DECIMAL,
  is_active BOOLEAN,
  created_at TIMESTAMP,
  updated_at TIMESTAMP
);
```

### Delivery Rules
```sql
CREATE TABLE delivery_rules (
  id UUID PRIMARY KEY,
  name VARCHAR,
  rule_type VARCHAR (distance, order_value, zone),
  min_distance DECIMAL,
  max_distance DECIMAL,
  min_order_value DECIMAL,
  max_order_value DECIMAL,
  geo_zone_id UUID,
  fee DECIMAL,
  is_active BOOLEAN,
  priority INTEGER,
  created_at TIMESTAMP,
  updated_at TIMESTAMP
);
```

### Delivery Discounts
```sql
CREATE TABLE delivery_discounts (
  id UUID PRIMARY KEY,
  name VARCHAR,
  discount_type VARCHAR (percentage, fixed_amount),
  discount_value DECIMAL,
  min_order_value DECIMAL,
  valid_from TIMESTAMP,
  valid_until TIMESTAMP,
  is_active BOOLEAN,
  created_at TIMESTAMP,
  updated_at TIMESTAMP
);
```

---

## 11. الاتصال والدعم

إذا واجهت أي مشاكل:
1. تحقق من هذا الدليل أولاً
2. افتح وحدة التطوير (DevTools) لعرض الأخطاء
3. تحقق من سجلات الخادم (Server Logs)
4. اتصل بفريق الدعم التقني

---

**آخر تحديث: 2026-02-20**
